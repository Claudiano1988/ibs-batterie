<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBS Batterie</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #667eea; font-size: 28px; }
        .header img { height: 50px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { background: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; }
        .tab.active { background: #667eea; color: white; }
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input[type="text"], input[type="number"], input[type="file"], textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; font-size: 14px; }
        button { background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #5568d3; }
        .product-list { max-height: 300px; overflow-y: auto; }
        .product-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .product-item:hover { background: #f5f5f5; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px; }
        .label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .value { font-size: 16px; font-weight: bold; }
        .price-box { background: #f0f4ff; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .quote-box { background: #f5f5f5; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 13px; }
        .hidden { display: none; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-primary { flex: 1; }
        .btn-success { flex: 1; background: #10b981; }
        .btn-success:hover { background: #059669; }
        .history-item { background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .search-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-tab { flex: 1; padding: 10px; background: #f3f4f6; border: none; border-radius: 5px; cursor: pointer; }
        .search-tab.active { background: #667eea; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>IBS Batterie</h1>
                <p style="color: #666;">Gestione Preventivi</p>
            </div>
            <img src="https://www.ibsbatterie.it/wp-content/uploads/2020/01/logo.png" alt="Logo" onerror="this.style.display='none'">
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('search')">üîç Ricerca</button>
            <button class="tab" onclick="showTab('upload')">üì§ Carica File</button>
            <button class="tab" onclick="showTab('history')">üïê Storico</button>
        </div>

        <div id="searchTab">
            <div class="card">
                <div class="search-tabs">
                    <button class="search-tab active" onclick="setSearchType('code')">Cerca per Codice</button>
                    <button class="search-tab" onclick="setSearchType('dim')">Cerca per Dimensioni</button>
                </div>

                <div id="codeSearch">
                    <input type="text" id="searchInput" placeholder="Cerca codice articolo..." oninput="search()">
                    <div id="results" class="product-list"></div>
                </div>

                <div id="dimSearch" class="hidden">
                    <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div>
                            <div class="label">Lunghezza (mm)</div>
                            <input type="number" id="dimL" placeholder="260" oninput="searchByDim()">
                        </div>
                        <div>
                            <div class="label">Larghezza (mm)</div>
                            <input type="number" id="dimW" placeholder="180" oninput="searchByDim()">
                        </div>
                        <div>
                            <div class="label">Altezza (mm)</div>
                            <input type="number" id="dimH" placeholder="247" oninput="searchByDim()">
                        </div>
                    </div>
                    <div id="dimResults" class="product-list"></div>
                </div>
            </div>

            <div id="productCard" class="card hidden">
                <h2 id="prodCode" style="color: #667eea; margin-bottom: 15px;"></h2>
                <div class="grid">
                    <div><div class="label">Tensione</div><div class="value" id="prodV"></div></div>
                    <div><div class="label">Capacit√†</div><div class="value" id="prodAh"></div></div>
                    <div><div class="label">Dimensioni</div><div class="value" id="prodDim"></div></div>
                    <div><div class="label">Peso</div><div class="value" id="prodPeso"></div></div>
                    <div><div class="label">Q.t√† Pallet</div><div class="value" id="prodPallet"></div></div>
                </div>

                <div style="margin-top: 20px;">
                    <div class="label">Prezzo Listino</div>
                    <div class="value" id="prodListino" style="font-size: 20px; margin-bottom: 15px;"></div>
                    
                    <div class="grid">
                        <div>
                            <div class="label">Sconto 1 %</div>
                            <input type="number" id="disc1" placeholder="0" min="0" max="100" step="0.1" oninput="calculate()">
                        </div>
                        <div>
                            <div class="label">Sconto 2 %</div>
                            <input type="number" id="disc2" placeholder="0" min="0" max="100" step="0.1" oninput="calculate()">
                        </div>
                    </div>

                    <div class="label">Quantit√†</div>
                    <input type="number" id="qty" value="1" min="1" oninput="calculate()">

                    <div class="price-box">
                        <span style="font-size: 18px; font-weight: bold; color: #667eea;">Prezzo Netto:</span>
                        <span id="netPrice" style="font-size: 24px; font-weight: bold; color: #667eea;">‚Ç¨0.00</span>
                    </div>

                    <div class="btn-group">
                        <button class="btn-primary" onclick="copyQuote()">üìã Copia Preventivo</button>
                        <button class="btn-success" onclick="saveHistory()">üíæ Salva Storico</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="uploadTab" class="hidden">
            <div class="card">
                <h3>Carica Listino Prodotti</h3>
                <input type="file" id="listFile" accept=".csv,.xlsx,.xls" onchange="loadList(event)">
                <p style="color: #666; font-size: 12px; margin-top: 5px;">Prodotti caricati: <span id="prodCount">0</span></p>
            </div>
            <div class="card">
                <h3>Carica Giacenze</h3>
                <input type="file" id="stockFile" accept=".xlsx,.xls" onchange="loadStock(event)">
                <p style="color: #666; font-size: 12px; margin-top: 5px;">Giacenze caricate: <span id="stockCount">0</span></p>
            </div>
        </div>

        <div id="historyTab" class="hidden">
            <div id="historyList"></div>
            <div id="emptyHistory" class="card" style="text-align: center; padding: 40px;">
                <p style="color: #999;">Nessun preventivo salvato</p>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let stock = [];
        let history = [];
        let selectedProduct = null;
        let searchType = 'code';

        // Carica dati salvati
        window.onload = () => {
            products = JSON.parse(localStorage.getItem('products') || '[]');
            stock = JSON.parse(localStorage.getItem('stock') || '[]');
            history = JSON.parse(localStorage.getItem('history') || '[]');
            document.getElementById('prodCount').textContent = products.length;
            document.getElementById('stockCount').textContent = stock.length;
            renderHistory();
        };

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('searchTab').className = tab === 'search' ? '' : 'hidden';
            document.getElementById('uploadTab').className = tab === 'upload' ? '' : 'hidden';
            document.getElementById('historyTab').className = tab === 'history' ? '' : 'hidden';
        }

        function setSearchType(type) {
            searchType = type;
            document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('codeSearch').className = type === 'code' ? '' : 'hidden';
            document.getElementById('dimSearch').className = type === 'dim' ? '' : 'hidden';
        }

        function loadList(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                let text = evt.target.result;
                
                // Rimuovi BOM se presente
                if (text.charCodeAt(0) === 0xFEFF) {
                    text = text.substr(1);
                }
                
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                
                if (lines.length === 0) {
                    alert('File vuoto!');
                    return;
                }
                
                const headers = lines[0].split(';');
                console.log('Headers:', headers);
                
                products = lines.slice(1).map(line => {
                    const vals = line.split(';').map(v => v.trim());
                    
                    // Pulisci il prezzo
                    let price = vals[9] || '0';
                    price = price.replace('‚Ç¨', '').replace(/\s/g, '').replace(',', '.');
                    
                    return {
                        codice: (vals[0] || '').trim(),
                        v: (vals[1] || '').trim(),
                        ah: (vals[2] || '').trim(),
                        lunghezza: (vals[3] || '').trim(),
                        larghezza: (vals[4] || '').trim(),
                        altezza: (vals[5] || '').trim(),
                        peso: (vals[7] || '').trim(),
                        qtaPallet: (vals[8] || '').trim(),
                        listino: parseFloat(price) || 0
                    };
                }).filter(p => p.codice); // Filtra righe vuote
                
                localStorage.setItem('products', JSON.stringify(products));
                document.getElementById('prodCount').textContent = products.length;
                alert(`${products.length} prodotti caricati correttamente!`);
                
                console.log('Primi 3 prodotti:', products.slice(0, 3));
            };
            
            // Prova con encoding UTF-8
            reader.readAsText(file, 'UTF-8');
        }

        function loadStock(e) {
            alert('Per le giacenze, usa file Excel. Funzionalit√† in sviluppo.');
        }

        function search() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            if (!term) {
                document.getElementById('results').innerHTML = '';
                return;
            }
            
            const filtered = products.filter(p => p.codice.toLowerCase().includes(term)).slice(0, 20);
            document.getElementById('results').innerHTML = filtered.map(p => 
                `<div class="product-item" onclick="selectProduct('${p.codice}')">
                    <div style="font-weight: bold;">${p.codice}</div>
                    <div style="font-size: 12px; color: #666;">${p.v}V - ${p.ah}Ah - ‚Ç¨${p.listino.toFixed(2)}</div>
                </div>`
            ).join('');
        }

        function searchByDim() {
            const l = parseFloat(document.getElementById('dimL').value) || 0;
            const w = parseFloat(document.getElementById('dimW').value) || 0;
            const h = parseFloat(document.getElementById('dimH').value) || 0;
            
            if (!l && !w && !h) {
                document.getElementById('dimResults').innerHTML = '';
                return;
            }
            
            const filtered = products.filter(p => {
                const pl = parseFloat(p.lunghezza) || 0;
                const pw = parseFloat(p.larghezza) || 0;
                const ph = parseFloat(p.altezza) || 0;
                
                const matchL = l ? Math.abs(pl - l) <= 10 : true;
                const matchW = w ? Math.abs(pw - w) <= 10 : true;
                const matchH = h ? Math.abs(ph - h) <= 10 : true;
                
                return matchL && matchW && matchH;
            }).slice(0, 20);
            
            document.getElementById('dimResults').innerHTML = filtered.map(p => 
                `<div class="product-item" onclick="selectProduct('${p.codice}')">
                    <div style="font-weight: bold;">${p.codice}</div>
                    <div style="font-size: 12px; color: #666;">${p.lunghezza}x${p.larghezza}x${p.altezza}mm - ‚Ç¨${p.listino.toFixed(2)}</div>
                </div>`
            ).join('');
        }

        function selectProduct(code) {
            selectedProduct = products.find(p => p.codice === code);
            if (!selectedProduct) return;
            
            document.getElementById('productCard').classList.remove('hidden');
            document.getElementById('prodCode').textContent = selectedProduct.codice;
            document.getElementById('prodV').textContent = selectedProduct.v + 'V';
            document.getElementById('prodAh').textContent = selectedProduct.ah + 'Ah';
            document.getElementById('prodDim').textContent = `${selectedProduct.lunghezza}x${selectedProduct.larghezza}x${selectedProduct.altezza}mm`;
            document.getElementById('prodPeso').textContent = selectedProduct.peso + 'kg';
            document.getElementById('prodPallet').textContent = selectedProduct.qtaPallet || '-';
            document.getElementById('prodListino').textContent = '‚Ç¨' + selectedProduct.listino.toFixed(2);
            
            document.getElementById('disc1').value = '';
            document.getElementById('disc2').value = '';
            document.getElementById('qty').value = 1;
            
            document.getElementById('searchInput').value = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('dimL').value = '';
            document.getElementById('dimW').value = '';
            document.getElementById('dimH').value = '';
            document.getElementById('dimResults').innerHTML = '';
            
            calculate();
            
            document.getElementById('productCard').scrollIntoView({behavior: 'smooth'});
        }

        function calculate() {
            if (!selectedProduct) return;
            
            const list = selectedProduct.listino;
            const d1 = parseFloat(document.getElementById('disc1').value) || 0;
            const d2 = parseFloat(document.getElementById('disc2').value) || 0;
            
            const after1 = list * (1 - d1/100);
            const final = after1 * (1 - d2/100);
            
            document.getElementById('netPrice').textContent = '‚Ç¨' + final.toFixed(2);
        }

        function copyQuote() {
            if (!selectedProduct) return;
            
            const qty = document.getElementById('qty').value;
            const net = document.getElementById('netPrice').textContent;
            
            const quote = `CODICE ARTICOLO: ${selectedProduct.codice}
TENSIONE: ${selectedProduct.v}V
CAPACIT√Ä: ${selectedProduct.ah}Ah
DIMENSIONI: ${selectedProduct.lunghezza}x${selectedProduct.larghezza}x${selectedProduct.altezza}mm

Q.T√Ä OFFERTA: ${qty} pz
PREZZO NETTO: ${net} cad.

CONSEGNA: Pronta Consegna`;
            
            navigator.clipboard.writeText(quote);
            alert('Preventivo copiato!');
        }

        function saveHistory() {
            if (!selectedProduct) return;
            
            const item = {
                id: Date.now(),
                date: new Date().toLocaleString('it-IT'),
                codice: selectedProduct.codice,
                qty: document.getElementById('qty').value,
                price: document.getElementById('netPrice').textContent,
                disc1: document.getElementById('disc1').value || 0,
                disc2: document.getElementById('disc2').value || 0
            };
            
            history.unshift(item);
            history = history.slice(0, 20);
            localStorage.setItem('history', JSON.stringify(history));
            
            document.getElementById('qty').value = 1;
            
            alert('Salvato nello storico!');
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const empty = document.getElementById('emptyHistory');
            
            if (history.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            list.innerHTML = history.map(h => `
                <div class="history-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: bold; font-size: 16px;">${h.codice}</div>
                            <div style="font-size: 12px; color: #666;">${h.date}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: #666;">${h.disc1}% + ${h.disc2}% - ${h.qty}pz</div>
                            <div style="font-size: 18px; font-weight: bold; color: #667eea;">${h.price}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button style="flex: 1;" onclick="copyHistoryQuote(${h.id})">üìã Copia</button>
                        <button class="btn-danger" onclick="deleteHistory(${h.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function copyHistoryQuote(id) {
            const item = history.find(h => h.id === id);
            if (!item) return;
            
            const prod = products.find(p => p.codice === item.codice);
            if (!prod) {
                alert('Prodotto non trovato nel listino');
                return;
            }
            
            const quote = `CODICE ARTICOLO: ${prod.codice}
TENSIONE: ${prod.v}V
CAPACIT√Ä: ${prod.ah}Ah
DIMENSIONI: ${prod.lunghezza}x${prod.larghezza}x${prod.altezza}mm

Q.T√Ä OFFERTA: ${item.qty} pz
PREZZO NETTO: ${item.price} cad.

CONSEGNA: Pronta Consegna`;
            
            navigator.clipboard.writeText(quote);
            alert('Preventivo copiato!');
        }

        function deleteHistory(id) {
            history = history.filter(h => h.id !== id);
            localStorage.setItem('history', JSON.stringify(history));
            renderHistory();
        }
    </script>
</body>
</html>
